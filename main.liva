// ============================================================================
// LIVA COMPREHENSIVE SYNTAX DEMONSTRATION
// ============================================================================
// This file demonstrates all major Liva language features for testing

// ============================================================================
// FUNCTIONS (One-liner style)
// ============================================================================

add(a, b) => a + b
multiply(x, y) => x * y
isAdult(age) => age >= 18

// Block function
calculateTotal(items) {
  let total = 0.0
  for item in items {
    total = total + item.price
  }
  return total
}

// Async helpers for concurrency demos
fetchUser(id: number): string {
  print($"ğŸ“¡ Fetching user {id}...")
  return $"User {id}"
}

heavyComputation(value: number): number {
  let result = value * value
  print($"ğŸ§  Heavy computation for {value} finished with {result}")
  return result
}

logEvent(msg: string) {
  print($"[LOG] {msg}")
}

backgroundCleanup() {
  print("ğŸ§¹ Background cleanup running")
}

// ============================================================================
// CLASS DEFINITIONS
// ============================================================================

// Class definition with constructor, fields, and methods
Person {
  constructor(name: string, age: int) {
    this.name = name
    this.age = age
  }

  name: string
  age: int

  isAdult() => this.age >= 18
}

// ============================================================================
// FALLIBILITY FUNCTIONS
// ============================================================================

// FunciÃ³n fallable bÃ¡sica
divide(a: number, b: number) => b == 0 ? fail "Division by zero" : a / b

// FunciÃ³n con if fail
validateUser(username: string, password: string): string {
  if username == "" fail "Username cannot be empty"
  if password == "" fail "Password cannot be empty"
  return $"User {username} validated"
}

// FunciÃ³n normal (no fallable)

// ============================================================================
// MAIN APPLICATION
// ============================================================================

main() {
  // ============================================================================
  // 1. VARIABLES AND CONSTANTS âœ…
  // ============================================================================

  // Basic types and variables
  let name = "Liva User"
  let age = 25
  let height = 1.75
  let isActive = true

  // Constants
  const MAX_USERS = 100
  const API_VERSION = "v1.0"

  print("ğŸš€ Liva Comprehensive Syntax Test Starting...\n")

  // ============================================================================
  // VARIABLES AND CONSTANTS DEMO âœ…
  // ============================================================================
  print("ğŸ“Š Testing Variables and Constants:")
  print($"Name: {name}, Age: {age}, Height: {height}")
  print($"Active: {isActive}")
  print($"Max users: {MAX_USERS}, API version: {API_VERSION}\n")

  // ============================================================================
  // 2. FUNCTION CALLS DEMO âœ…
  // ============================================================================
  print("ğŸ”§ Testing Function Calls:")

  let sum = add(10, 15)
  let product = multiply(4, 6)
  let adult = isAdult(age)

  print($"10 + 15 = {sum}")
  print($"4 * 6 = {product}")
  print($"Is adult: {adult}\n")

  // ============================================================================
  // 3. STRING TEMPLATES DEMO âœ…
  // ============================================================================
  print("ğŸ“ Testing String Templates:")

  let greeting = $"Hello {name}! You are {age} years old."
  let status = "User is active"

  print(greeting)
  print(status)

  // ============================================================================
  // 4. ARITHMETIC OPERATIONS DEMO âœ…
  // ============================================================================
  print("ğŸ§® Testing Arithmetic Operations:")

  let calculations = [
    10 + 5,
    20 - 8,
    6 * 7,
    100 / 4,
    17 % 3
  ]

  print($"Calculations: {calculations}")

  // ============================================================================
  // 5. LOGICAL OPERATORS DEMO âœ…
  // ============================================================================
  print("ğŸ”€ Testing Logical Operators:")

  let canVote = age >= 18 and isActive
  let shouldShow = age > 21 or isActive

  print($"Can vote: {canVote}")
  print($"Should show: {shouldShow}")

  // ============================================================================
  // 6. CONTROL FLOW DEMO âœ…
  // ============================================================================
  print("ğŸ”„ Testing Control Flow:")

  // If/else with logical operators
  if age >= 18 and isActive {
    print("âœ… User can vote and is active")
  } else if age >= 18 {
    print("âš ï¸ User can vote but is inactive")
  } else {
    print("âŒ User cannot vote")
  }

  // For loop with range
  print("\nCounting to 5:")
  for i in 1..6 {
    print($"Count: {i}")
  }

  // While loop
  let counter = 0
  while counter < 3 {
    print($"While iteration: {counter}")
    counter = counter + 1
  }

  // Switch statement
  let userType = "premium"
  switch userType {
    case "premium": print("ğŸ‘‘ Premium user")
    case "standard": print("ğŸ†“ Standard user")
    case "guest": print("ğŸ‘¤ Guest user")
    default: print("â“ Unknown user type")
  }

  print()

  // ============================================================================
  // 7. ARRAYS AND OBJECTS DEMO âœ…
  // ============================================================================
  print("ğŸ“¦ Testing Arrays and Objects:")

  // Simple array
  let numbers = [1, 2, 3, 4, 5]

  // Array of objects
  let users = [
    { name: "Alice", age: 25 },
    { name: "Bob", age: 30 },
    { name: "Charlie", age: 35 }
  ]

  print($"Numbers: {numbers}")
  print($"Users count: {users.length}")
  print($"First user: {users[0].name} and his age is {users[0].age}")

  // ============================================================================
  // 8. BLOCK FUNCTIONS DEMO âœ…
  // ============================================================================
  print("ğŸ—ï¸ Testing Block Functions:")

  let products = [
    { name: "Laptop", price: 999.99 },
    { name: "Book", price: 19.99 },
    { name: "Coffee", price: 4.50 }
  ]

  let totalPrice = calculateTotal(products)  // Note: compiler should handle reference
  print($"Total price: ${totalPrice}")

  // ============================================================================
  // 9. CONCURRENCY FEATURES âœ…
  // ============================================================================
  print("\nâš™ï¸ Testing Concurrency Features:")

  let asyncUser = async fetchUser(1)
  let parallelResult = par heavyComputation(12)

  let taskUser = task async fetchUser(2)
  let taskCompute = task par heavyComputation(8)

  fire async logEvent($"Fire-and-forget async event triggered")
  fire par backgroundCleanup()

  print($"Async user value: {asyncUser}")
  print($"Parallel result (lazy join): {parallelResult}")

  let _taskUserResult = await taskUser
  let _taskComputeResult = await taskCompute

  print("Task handles awaited successfully âœ…")

  // ============================================================================
  // 10. DATA-PARALLEL FOR POLICIES DEMO âœ…
  // ============================================================================
  print("\nğŸ§µ Testing Data-Parallel For Policies:")

  let parallelWorkloads = [1, 2, 3, 4]

  for par workload in parallelWorkloads with chunk 2 threads 4 {
    print($"Processing workload {workload} on a parallel worker")
  }

  let vectorWorkloads = [1, 2, 3, 4]

  for parvec lane in vectorWorkloads with simdWidth 4 ordered {
    print($"Vector lane value: {lane}")
  }

  // ============================================================================
  // 11. CLASSES AND OBJECTS DEMO âœ…
  // ============================================================================
  print("\nğŸ—ï¸ Testing Classes and Objects:")

  // Using the class - constructor with parameters
  let person1 = Person("Fran", 40)

  print($"Person 1: {person1.name}, Age: {person1.age}")
  print($"Is adult: {person1.isAdult()}")

  // Using the class - object literal syntax
  let person2 = Person {
    name: "Ana",
    age: 30
  }

  print($"Person 2: {person2.name}, Age: {person2.age}")
  print($"Is adult: {person2.isAdult()}")

  // Demonstrate multiple instances
  let people = [
    Person("Alice", 25),
    Person("Bob", 17),
    Person("Charlie", 35)
  ]

  for person in people {
    print($"Name: {person.name}, Age: {person.age}, Adult: {person.isAdult()}")
  }

  // ============================================================================
  // 12. FALLIBILITY SYSTEM DEMO âœ…
  // ============================================================================
  print("\nğŸ›¡ï¸ Testing Fallibility System:")

  // Test binding fallible - funciÃ³n fallable
  let result, err = divide(10, 2)
  print($"Division success: {result}, error: {err}")
  
  // ============================================================================
  // 12.1 ERROR BINDING WITH ASYNC/PAR (PHASE 1) ğŸ†•
  // ============================================================================
  print("\nğŸ”¥ Testing Error Binding with Async/Par:")
  
  // Error binding with async call (lazy await on first use)
  let divResult, divErr = async divide(20, 4)
  print($"Async division: {divResult}, error: {divErr}")
  
  // Error binding with par call (lazy join on first use)
  let parResult, parErr = par divide(15, 3)
  print($"Parallel division: {parResult}, error: {parErr}")
  
  // Async error handling - division by zero
  let asyncFailResult, asyncFailErr = async divide(10, 0)
  if asyncFailErr != "" {
    print($"Async error caught: {asyncFailErr}")
  } else {
    print($"Async result: {asyncFailResult}")
  }
  
  // Par error handling - success case
  let parSuccessResult, parSuccessErr = par validateUser("alice", "pass123")
  if parSuccessErr != "" {
    print($"Par validation error: {parSuccessErr}")
  } else {
    print($"Par validation success: {parSuccessResult}")
  }
  
  // Ignore error with dummy variable
  let onlyValue, ignored = async divide(100, 5)
  print($"Value only (error ignored): {onlyValue}")

  let result2, err2 = divide(10, 0)
  print($"Division with error: {result2}, error: {err2}")

  // Test binding fallible - funciÃ³n normal (err serÃ¡ null)
  let result_mult, err3 = multiply(5, 3)
  print($"Multiplication: {result_mult}, error: {err3}")

  // Test if fail statement
  let userResult, userErr = validateUser("john", "pass123")
  print($"User validation: {userResult}, error: {userErr}")

  let userResult2, userErr2 = validateUser("", "pass123")
  print($"User validation with error: {userResult2}, error: {userErr2}")

  let userResult3,err4 = validateUser("", "pass123")
  print($"User validation with error: 3 {userResult3}")

  // Test ternario con fail
  let user_age = 15
  let voting_result, voteErr = user_age >= 18 ? "Can vote" : fail "Too young to vote"
  print($"Voting check: {voting_result}, error: {voteErr}")

  print("\nğŸ‰ Liva Comprehensive Syntax Test Completed Successfully!")
  print("âœ… All major language features tested and working!")
  print("ğŸ›¡ï¸ Fallibility system implemented and tested!")
}
